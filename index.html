<!DOCTYPE html>
<html lang="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoCode Towing - Calculator</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --att-blue: #0057B8; --white: #FFFFFF; --text-dark: #333; --green-sms: #25D366; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; padding: 0; background: var(--white); overflow-x: hidden; }
        .top-bar { padding: 10px 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .brand { text-align: center; font-weight: 900; color: var(--att-blue); margin-bottom: 10px; text-transform: uppercase; }
        .address-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .input-group { position: relative; flex: 3; }
        .zip-group { flex: 1; }
        .input-group i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--att-blue); }
        input { width: 100%; padding: 12px 10px 12px 35px; border: 2px solid #EEE; border-radius: 8px; font-size: 1rem; box-sizing: border-box; outline: none; }
        .zip-group input { padding-left: 10px; text-align: center; }
        .action-buttons { display: flex; gap: 10px; margin-top: 5px; }
        .btn-calc { background: var(--att-blue); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 700; flex: 2; cursor: pointer; text-transform: uppercase; }
        .btn-reset { background: #555; color: white; border: none; padding: 14px; border-radius: 8px; flex: 1; cursor: pointer; text-transform: uppercase; }
        #map { height: 30vh; width: 100%; position: relative; }
        .map-info-card { position: absolute; bottom: 10px; left: 10px; background: white; padding: 8px 15px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 500; display: none; border-left: 4px solid var(--att-blue); font-weight: 800; font-size: 1.1rem; }
        .section-label { text-align: center; font-size: 0.75rem; font-weight: 700; color: #666; text-transform: uppercase; margin: 15px 0 10px 0; }
        .grid-buttons { display: grid; gap: 8px; padding: 0 15px; grid-template-columns: repeat(3, 1fr); }
        .btn-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.4; padding: 10px; border-radius: 10px; transition: 0.2s; border: 1px solid #EEE; }
        .btn-item.active { opacity: 1; background-color: #f0f8ff; border-color: var(--att-blue); }
        .icon-circle { width: 40px; height: 40px; border-radius: 50%; background: var(--att-blue); display: flex; justify-content: center; align-items: center; color: white; margin-bottom: 5px; }
        .btn-text { font-size: 0.7rem; font-weight: 700; text-align: center; }
        .summary-panel { padding: 15px; background: #F8F9FA; border-top: 1px solid #EEE; margin-top: 15px; }
        .total-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 2px solid #DDD; padding-top: 10px; }
        .price-total { font-weight: 900; font-size: 1.8rem; color: var(--att-blue); }
        .btn-sms { background: var(--green-sms); color: white; border: none; padding: 15px 25px; border-radius: 10px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .price-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; color: #555; }
        .leaflet-routing-container { display: none !important; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="brand">AutoCode Towing Services</div>
        <div class="address-row">
            <div class="input-group">
                <i class="fas fa-map-marker-alt"></i>
                <input type="text" id="startInput" data-i18n-placeholder="pickup_placeholder" placeholder="Recogida / Pickup">
            </div>
            <div class="zip-group"><input type="number" id="startZip" placeholder="Zip"></div>
        </div>
        <div class="address-row">
            <div class="input-group">
                <i class="fas fa-flag-checkered"></i>
                <input type="text" id="endInput" data-i18n-placeholder="dest_placeholder" placeholder="Destino / Destination">
            </div>
            <div class="zip-group"><input type="number" id="endZip" placeholder="Zip"></div>
        </div>
        <div class="action-buttons">
            <button class="btn-calc" onclick="handleSearchButton()" id="btnCalcText">Calcular Precio / Calculate</button>
            <button class="btn-reset" onclick="window.location.reload()" id="btnResetText">Reiniciar</button>
        </div>
    </div>

    <div id="map">
        <div id="routeInfoCard" class="map-info-card"><span id="totalMilesDisplay">0</span> mi</div>
    </div>

    <div class="bottom-sheet">
        <div class="section-label" id="vehicleLabel">Vehículo / Vehicle</div>
        <div class="grid-buttons">
            <div class="btn-item active" onclick="setVehicle('regular', this)">
                <div class="icon-circle"><i class="fas fa-car-side"></i></div>
                <div class="btn-text">REGULAR</div>
            </div>
            <div class="btn-item" onclick="setVehicle('xl', this)">
                <div class="icon-circle"><i class="fas fa-truck-monster"></i></div>
                <div class="btn-text">EXTRA LARGE</div>
            </div>
            <div class="btn-item" onclick="setVehicle('wrecked', this)">
                <div class="icon-circle"><i class="fas fa-car-crash"></i></div>
                <div class="btn-text">CHOCADO / WRECKED</div>
            </div>
        </div>

        <div class="summary-panel" id="summaryPanel">
            <div class="price-row"> <span id="lblBase">Base:</span> <span id="valBase">$0</span> </div>
            <div class="price-row"> <span id="lblExtra">Millas Extra:</span> <span id="valExtra">$0</span> </div>
            <div class="price-row"> <span id="lblAfterHours">After Hours:</span> <span id="valAfterHours">$0</span> </div>
            <div class="price-row"> <span id="lblBaseDist">Base Distance Fee:</span> <span id="valBaseDist">$0</span> </div>
            
            <div class="total-row">
                <div>
                    <div style="font-size:0.7rem; color: #666;" id="lblTotalEst">TOTAL ESTIMADO / ESTIMATED TOTAL</div>
                    <span class="price-total" id="totalPrice">$0.00</span>
                </div>
                <button class="btn-sms" onclick="sendSMS()"><span id="btnSmsText">ORDENAR</span> <i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        const BASE_LOC = { lat: 36.1765, lon: -115.1751 }; // 2401 W Bonanza Rd
        const VEHICLE_RATES = { 'regular': 100, 'xl': 130, 'wrecked': 150 };
        const FREE_MILES = 10;
        const PRICE_PER_MILE = 7;

        let currentMiles = 0;
        let distFromBase = 0;
        let currentVehicleType = 'regular';
        let lang = navigator.language.startsWith('es') ? 'es' : 'en';

        const i18n = {
            es: { pickup_placeholder: "Dirección de Recogida", dest_placeholder: "Dirección de Destino", btn_calc: "CALCULAR PRECIO", btn_reset: "REINICIAR", vehicle: "TIPO DE VEHÍCULO", base: "Tarifa Base", extra: "Millas Extra", total: "TOTAL ESTIMADO", order: "ORDENAR", after: "Horario Especial", baseDist: "Recogida Distante" },
            en: { pickup_placeholder: "Pickup Address", dest_placeholder: "Destination Address", btn_calc: "CALCULATE PRICE", btn_reset: "RESET", vehicle: "VEHICLE TYPE", base: "Base Rate", extra: "Extra Miles", total: "ESTIMATED TOTAL", order: "ORDER NOW", after: "After Hours Fee", baseDist: "Long Distance Pickup" }
        };

        function applyLanguage() {
            const t = i18n[lang];
            document.getElementById('startInput').placeholder = t.pickup_placeholder;
            document.getElementById('endInput').placeholder = t.dest_placeholder;
            document.getElementById('btnCalcText').innerText = t.btn_calc;
            document.getElementById('btnResetText').innerText = t.btn_reset;
            document.getElementById('vehicleLabel').innerText = t.vehicle;
            document.getElementById('lblBase').innerText = t.base;
            document.getElementById('lblExtra').innerText = t.extra;
            document.getElementById('lblTotalEst').innerText = t.total;
            document.getElementById('btnSmsText').innerText = t.order;
            document.getElementById('lblAfterHours').innerText = t.after;
            document.getElementById('lblBaseDist').innerText = t.baseDist;
        }
        applyLanguage();

        var map = L.map('map', {zoomControl: false}).setView([36.1699, -115.1398], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
        var routingControl = null;

        async function getCoords(addr, zip) {
            let query = addr + (zip ? " " + zip : "") + ", Las Vegas, NV";
            try {
                let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                let data = await res.json();
                return data.length > 0 ? data[0] : null;
            } catch { return null; }
        }

        function calculateDist(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Millas
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function handleSearchButton() {
            const sT = document.getElementById('startInput').value;
            const sZ = document.getElementById('startZip').value;
            const eT = document.getElementById('endInput').value;
            const eZ = document.getElementById('endZip').value;
            
            if(!sT || !eT) return;
            const sC = await getCoords(sT, sZ);
            const eC = await getCoords(eT, eZ);
            
            if(sC && eC) {
                distFromBase = calculateDist(BASE_LOC.lat, BASE_LOC.lon, sC.lat, sC.lon);
                if(routingControl) map.removeControl(routingControl);
                routingControl = L.Routing.control({
                    waypoints: [L.latLng(sC.lat, sC.lon), L.latLng(eC.lat, eC.lon)],
                    createMarker: () => null,
                    lineOptions: { styles: [{color: '#0057B8', weight: 6}] }
                }).addTo(map);

                routingControl.on('routesfound', (ev) => {
                    currentMiles = ev.routes[0].summary.totalDistance * 0.000621371;
                    document.getElementById('routeInfoCard').style.display = 'block';
                    document.getElementById('totalMilesDisplay').innerText = currentMiles.toFixed(1);
                    updateCalculations();
                });
            }
        }

        function updateCalculations() {
            if(currentMiles === 0) return;
            
            let base = VEHICLE_RATES[currentVehicleType];
            let extraMilesFee = currentMiles > FREE_MILES ? (currentMiles - FREE_MILES) * PRICE_PER_MILE : 0;
            let baseDistFee = distFromBase > 10 ? 20 : 0;
            
            // Horarios
            let hour = new Date().getHours();
            let afterHoursFee = 0;
            if (hour >= 18 && hour < 21) afterHoursFee = 20;
            else if (hour >= 21 && hour <= 23) afterHoursFee = 40;
            else if (hour >= 0 && hour < 6) afterHoursFee = 100;

            let total = base + extraMilesFee + baseDistFee + afterHoursFee;

            document.getElementById('valBase').innerText = '$' + base;
            document.getElementById('valExtra').innerText = '$' + extraMilesFee.toFixed(2);
            document.getElementById('valBaseDist').innerText = '$' + baseDistFee;
            document.getElementById('valAfterHours').innerText = '$' + afterHoursFee;
            document.getElementById('totalPrice').innerText = '$' + total.toFixed(2);
        }

        function setVehicle(v, el) {
            currentVehicleType = v;
            document.querySelectorAll('.btn-item').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            updateCalculations();
        }

        function sendSMS() {
            let msg = `AUTOCODE TOWING\nFROM: ${document.getElementById('startInput').value}\nTO: ${document.getElementById('endInput').value}\nMILES: ${currentMiles.toFixed(1)}\nTOTAL: ${document.getElementById('totalPrice').innerText}`;
            window.location.href = `sms:7025029691?body=${encodeURIComponent(msg)}`;
        }
    </script>
</body>
</html>
